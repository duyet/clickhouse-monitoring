name: Reusable CI/CD Base

on:
  workflow_call:
    inputs:
      job-type:
        required: true
        type: string
      clickhouse-versions:
        type: string
        description: 'ClickHouse version as JSON array string (e.g. ''["24.5","24.6"]'')'
        default: '["24.5","24.6"]'
      platforms:
        type: string
        description: 'Platform(s) for Docker build (e.g., "linux/amd64,linux/arm64")'
        default: 'linux/amd64'
      push-image:
        type: boolean
        default: false
      load-image:
        type: boolean
        default: false
      test-container:
        type: boolean
        default: false
      image-tag:
        type: string
        description: 'Custom Docker image tag override'

    outputs:
      tags:
        value: ${{ jobs.job.outputs.tags }}
      first_tag:
        value: ${{ jobs.job.outputs.first_tag }}

env:
  CLICKHOUSE_HOST: http://localhost:8123
  CLICKHOUSE_USER: default
  CLICKHOUSE_PASSWORD: ''
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

permissions:
  contents: read
  id-token: write
  packages: write

jobs:
  job:
    name: ${{ inputs.job-type }}
    runs-on: ubuntu-latest
    outputs:
      tags: ${{ steps.meta.outputs.tags }}
      first_tag: ${{ steps.first_tag.outputs.tag }}

    strategy:
      fail-fast: false
      matrix:
        clickhouse-version: ${{ fromJSON(inputs.clickhouse-versions) }}

    services:
      clickhouse:
        image: ghcr.io/duyet/docker-images:clickhouse_${{ matrix.clickhouse-version }}
        ports:
          - 8123:8123
          - 9000:9000
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:8123/?query=SELECT%201 || exit 1"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 5
          --health-start-period 30s
          --env CLICKHOUSE_SKIP_USER_SETUP=1

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Next.js Cache
        uses: actions/cache@v5
        with:
          path: .next/cache
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-${{ hashFiles('**.[jt]s', '**.[jt]sx') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/bun.lock') }}-

      - name: Install dependencies
        run: bun install

      # === Linting ===
      - name: Lint
        if: ${{ inputs.job-type == 'lint' }}
        run: bun run lint

      # === App Build ===
      - name: Build App
        if: ${{ inputs.job-type == 'build' }}
        run: bun run build

      # === Docker Build ===
      - name: Set up QEMU
        if: ${{ inputs.job-type == 'docker' }}
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: ${{ inputs.job-type == 'docker' }}
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            network=host
            image=moby/buildkit:latest
        env:
          TMPDIR: /home/runner/work/_temp

      - name: Login to Container registry
        if: ${{ inputs.job-type == 'docker' && inputs.push-image }}
        uses: docker/login-action@6862ffc5ab2cdb4405cf318a62a6f4c066e2298b
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        if: ${{ inputs.job-type == 'docker' }}
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Branch name (e.g., main) - for main branch builds
            type=ref,event=branch
            # PR number - for PR builds
            type=ref,event=pr
            # Full version (e.g., 0.2.0, 0.2.0-beta.1)
            type=semver,pattern={{version}}
            # Major.Minor (e.g., 0.2) - only for stable releases, not pre-releases
            type=semver,pattern={{major}}.{{minor}}
            # Major version (e.g., 0) - only for stable releases, not pre-releases
            type=semver,pattern={{major}}
            # Latest tag - for main branch and stable releases only (not pre-releases)
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' || (startsWith(github.ref, 'refs/tags/') && !contains(github.ref_name, '-')) }}
            # Main tag - for main branch and all releases (stable and pre-release)
            type=raw,value=main,enable=${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/') }}
            # SHA for uniqueness
            type=sha,prefix=

      - name: Extract first tag
        if: ${{ inputs.job-type == 'docker' && inputs.test-container }}
        id: first_tag
        uses: actions/github-script@v7
        with:
          script: |
            const tags = JSON.parse('${{ steps.meta.outputs.json }}').tags;
            core.setOutput('tag', tags[0]);

      - name: Build and push Docker image
        if: ${{ inputs.job-type == 'docker' }}
        uses: docker/build-push-action@v6
        env:
          TMPDIR: /home/runner/work/_temp
        with:
          push: ${{ inputs.push-image }}
          load: ${{ inputs.load-image }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # Multi-layered cache strategy: registry (primary) + GitHub Actions (fallback)
          cache-from: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
            type=gha,scope=buildkit
          cache-to: |
            type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max
            type=gha,mode=max,scope=buildkit
          allow: network.host,security.insecure
          network: host
          platforms: ${{ inputs.platforms }}

      # === Container Testing ===
      - name: Test container
        if: ${{ inputs.job-type == 'docker' && inputs.test-container }}
        env:
          TAG: ${{ steps.first_tag.outputs.tag }}
        run: |
          docker run -d \
            --name test-app \
            --network host \
            -e CLICKHOUSE_HOST=http://localhost:8123 \
            -e CLICKHOUSE_USER=default \
            -e CLICKHOUSE_PASSWORD="" \
            -e PORT=3000 \
            "$TAG"

          # Wait for container health
          timeout 60 bash -c 'until curl -sSf http://localhost:3000/ > /dev/null 2>&1; do sleep 2; done'

          # Health checks
          curl -sSf http://localhost:3000/ | grep -q "ClickHouse Monitoring"
          curl -sSf http://localhost:3000/api/healthz | grep -q "ok"
          curl -sSf http://localhost:3000/api/version | grep -q "version"
